class AdminDashboard { constructor() { this.currentUser = null; this.currentSection = 'gallery'; this.images = []; this.categories = []; this.settings = { maxFileSize: 10, allowedFormats: ['jpg', 'png', 'gif', 'webp'], imagesPerPage: 24, compressionQuality: 85 }; this.currentPage = 1; this.selectedFiles = []; this.apiBase = 'api/'; this.baseUrl = 'uploads/images/'; this.init(); } init() { const adminDashboard = document.getElementById('adminDashboard'); const loginModal = document.getElementById('loginModal'); if (adminDashboard && !adminDashboard.classList.contains('hidden')) { console.log('Already logged in, setting up dashboard'); this.setupEventListeners(); this.showDashboard(); } else if (loginModal && loginModal.classList.contains('active')) { this.setupEventListeners(); this.showLogin(); } else { this.setupEventListeners(); this.checkAuthentication(); } } async checkAuthentication() { try { const response = await fetch(this.apiBase + 'auth.php'); const data = await response.json(); if (data.authenticated) { this.currentUser = data.user; this.showDashboard(); } else { this.showLogin(); } } catch (error) { console.error('Erro ao verificar autenticação:', error); this.showLogin(); } } showLogin() { document.getElementById('loginModal').classList.add('active'); document.getElementById('adminDashboard').classList.add('hidden'); } setupEventListeners() { const loginForm = document.getElementById('loginForm'); if (loginForm) { loginForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); }); } const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) { logoutBtn.addEventListener('click', () => { this.handleLogout(); }); } const navLinks = document.querySelectorAll('.nav-item a[data-section]'); console.log('Found nav links:', navLinks.length); navLinks.forEach((link, index) => { console.log(`Setting up link ${index}:`, link.dataset.section); link.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const section = link.dataset.section; console.log('Navigation clicked, section:', section); if (section) { this.switchSection(section); } }); }); const sidebarToggle = document.querySelector('.sidebar-toggle'); if (sidebarToggle) { sidebarToggle.addEventListener('click', () => { document.querySelector('.sidebar').classList.toggle('active'); }); } this.setupUploadListeners(); this.setupGalleryListeners(); this.setupCategoriesListeners(); this.setupSettingsListeners(); this.setupModalListeners(); } setupUploadListeners() { const uploadArea = document.getElementById('uploadArea'); const fileInput = document.getElementById('fileInput'); const selectFilesBtn = document.getElementById('selectFilesBtn'); const uploadBtn = document.getElementById('uploadBtn'); const clearBtn = document.getElementById('clearBtn'); if (selectFilesBtn && fileInput) { selectFilesBtn.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files)); } if (uploadArea) { uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); }); uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); }); uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); this.handleFileSelect(e.dataTransfer.files); }); } if (uploadBtn) { uploadBtn.addEventListener('click', () => this.handleUpload()); } if (clearBtn) { clearBtn.addEventListener('click', () => this.clearUpload()); } } setupGalleryListeners() { const categoryFilter = document.getElementById('categoryFilter'); const sortFilter = document.getElementById('sortFilter'); const searchInput = document.getElementById('searchInput'); const addImageBtn = document.getElementById('addImageBtn'); if (categoryFilter) { categoryFilter.addEventListener('change', () => this.filterImages()); } if (sortFilter) { sortFilter.addEventListener('change', () => this.filterImages()); } if (searchInput) { searchInput.addEventListener('input', () => this.filterImages()); } if (addImageBtn) { addImageBtn.addEventListener('click', () => { this.switchSection('upload'); }); } } setupCategoriesListeners() { const categoryForm = document.getElementById('categoryForm'); if (categoryForm) { categoryForm.addEventListener('submit', (e) => { e.preventDefault(); this.addCategory(); }); } } setupSettingsListeners() { const compressionQuality = document.getElementById('compressionQuality'); const saveSettingsBtn = document.getElementById('saveSettingsBtn'); const qualityValue = document.getElementById('qualityValue'); if (compressionQuality && qualityValue) { compressionQuality.addEventListener('input', (e) => { qualityValue.textContent = e.target.value + '%'; }); } if (saveSettingsBtn) { saveSettingsBtn.addEventListener('click', () => { this.saveSettings(); }); } } setupModalListeners() { document.querySelectorAll('.modal-close').forEach(btn => { btn.addEventListener('click', () => this.closeModal()); }); document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) this.closeModal(); }); }); const saveImageBtn = document.getElementById('saveImageBtn'); const deleteImageBtn = document.getElementById('deleteImageBtn'); if (saveImageBtn) { saveImageBtn.addEventListener('click', () => this.saveImageChanges()); } if (deleteImageBtn) { deleteImageBtn.addEventListener('click', () => this.deleteImage()); } } async handleLogin() { const username = document.getElementById('username').value; const password = document.getElementById('password').value; if (!username || !password) { this.showAlert('Por favor, preencha todos os campos', 'error'); return; } try { const response = await fetch(this.apiBase + 'auth.php', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ username, password }) }); const data = await response.json(); if (data.success) { this.currentUser = data.user; this.showDashboard(); this.showAlert('Login realizado com sucesso!', 'success'); } else { this.showAlert(data.error || 'Credenciais inválidas', 'error'); } } catch (error) { console.error('Erro no login:', error); this.showAlert('Erro de conexão. Tente novamente.', 'error'); } } async handleLogout() { try { await fetch(this.apiBase + 'auth.php', { method: 'DELETE' }); } catch (error) { console.error('Erro no logout:', error); } this.currentUser = null; document.getElementById('loginModal').classList.add('active'); document.getElementById('adminDashboard').classList.add('hidden'); document.getElementById('username').value = ''; document.getElementById('password').value = ''; } showDashboard() { const loginModal = document.getElementById('loginModal'); const adminDashboard = document.getElementById('adminDashboard'); if (loginModal) { loginModal.classList.remove('active'); } if (adminDashboard) { adminDashboard.classList.remove('hidden'); } this.loadCategories(); this.loadImages(); this.loadSettings(); } switchSection(section) { console.log('Switching to section:', section); document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); const navLink = document.querySelector(`[data-section="${section}"]`); if (navLink) { navLink.closest('.nav-item').classList.add('active'); } document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active')); const targetSection = document.getElementById(`${section}Section`); if (targetSection) { targetSection.classList.add('active'); } const titles = { gallery: 'Galeria de Imagens', upload: 'Upload de Imagens', categories: 'Gestão de Categorias', settings: 'Configurações' }; const pageTitle = document.getElementById('pageTitle'); if (pageTitle && titles[section]) { pageTitle.textContent = titles[section]; } this.currentSection = section; } async loadCategories() { try { const response = await fetch(this.apiBase + 'categories.php'); const data = await response.json(); if (Array.isArray(data)) { this.categories = data; this.renderCategories(); this.updateCategorySelects(); } } catch (error) { console.error('Erro ao carregar categorias:', error); this.showAlert('Erro ao carregar categorias', 'error'); } } async loadImages() { try { const params = new URLSearchParams({ page: this.currentPage, limit: this.settings.imagesPerPage }); const categoryFilter = document.getElementById('categoryFilter'); const searchInput = document.getElementById('searchInput'); const sortFilter = document.getElementById('sortFilter'); if (categoryFilter && categoryFilter.value) { params.append('category', categoryFilter.value); } if (searchInput && searchInput.value) { params.append('search', searchInput.value); } if (sortFilter && sortFilter.value) { params.append('sort', sortFilter.value); } const response = await fetch(this.apiBase + 'images.php?' + params); const data = await response.json(); if (data.images) { this.images = data.images; this.renderGallery(); this.renderPagination(data.total); } } catch (error) { console.error('Erro ao carregar imagens:', error); this.showAlert('Erro ao carregar imagens', 'error'); } } updateCategoryCounts() { this.categories.forEach(category => { category.count = this.images.filter(img => img.category === category.slug).length; }); } renderGallery() { const grid = document.getElementById('imageGrid'); const filteredImages = this.getFilteredImages(); if (filteredImages.length === 0) { grid.innerHTML = ` <div class="no-images"> <i class="fas fa-images" style="font-size: 3rem; color: var(--rock-blue); margin-bottom: 1rem;"></i> <h3>Nenhuma imagem encontrada</h3> <p>Adicione algumas imagens para começar.</p> </div> `; return; } grid.innerHTML = filteredImages.map(image => ` <div class="image-card" data-id="${image.id}"> <img src="${this.baseUrl}${image.filename}" alt="${image.title || image.filename}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlbTwvdGV4dD48L3N2Zz4='"> <div class="image-info"> <h4>${image.title || image.filename}</h4> <div class="image-meta"> <span class="image-category">${this.getCategoryName(image.category_id)}</span> <span>${this.formatFileSize(image.file_size)}</span> </div> </div> </div> `).join(''); document.querySelectorAll('.image-card').forEach(card => { card.addEventListener('click', () => { const imageId = parseInt(card.dataset.id); this.openImageModal(imageId); }); }); this.renderPagination(filteredImages.length); } getFilteredImages() { let filtered = [...this.images]; const categoryFilter = document.getElementById('categoryFilter').value; if (categoryFilter) { filtered = filtered.filter(img => img.category === categoryFilter); } const searchTerm = document.getElementById('searchInput').value.toLowerCase(); if (searchTerm) { filtered = filtered.filter(img => img.name.toLowerCase().includes(searchTerm) || img.tags.some(tag => tag.toLowerCase().includes(searchTerm)) || img.description.toLowerCase().includes(searchTerm) ); } const sortBy = document.getElementById('sortFilter').value; filtered.sort((a, b) => { switch (sortBy) { case 'date-desc': return new Date(b.uploadDate) - new Date(a.uploadDate); case 'date-asc': return new Date(a.uploadDate) - new Date(b.uploadDate); case 'name-asc': return a.name.localeCompare(b.name); case 'name-desc': return b.name.localeCompare(a.name); default: return 0; } }); return filtered; } filterImages() { this.currentPage = 1; this.loadImages(); } renderPagination(totalImages) { const pagination = document.getElementById('pagination'); const totalPages = Math.ceil(totalImages / this.settings.imagesPerPage); if (totalPages <= 1) { pagination.innerHTML = ''; return; } let paginationHTML = ''; paginationHTML += ` <button ${this.currentPage === 1 ? 'disabled' : ''} onclick="adminDashboard.changePage(${this.currentPage - 1})"> <i class="fas fa-chevron-left"></i> </button> `; for (let i = 1; i <= totalPages; i++) { if (i === this.currentPage || i === 1 || i === totalPages || (i >= this.currentPage - 1 && i <= this.currentPage + 1)) { paginationHTML += ` <button class="${i === this.currentPage ? 'active' : ''}" onclick="adminDashboard.changePage(${i})"> ${i} </button> `; } else if (i === this.currentPage - 2 || i === this.currentPage + 2) { paginationHTML += '<span>...</span>'; } } paginationHTML += ` <button ${this.currentPage === totalPages ? 'disabled' : ''} onclick="adminDashboard.changePage(${this.currentPage + 1})"> <i class="fas fa-chevron-right"></i> </button> `; pagination.innerHTML = paginationHTML; } changePage(page) { this.currentPage = page; this.loadImages(); } getCategoryName(categoryId) { const category = this.categories.find(cat => cat.id == categoryId); return category ? category.name : 'Sem categoria'; } formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; } handleFileSelect(files) { this.selectedFiles = Array.from(files).filter(file => { const extension = file.name.split('.').pop().toLowerCase(); return this.settings.allowedFormats.includes(extension); }); this.renderUploadPreview(); document.getElementById('uploadBtn').disabled = this.selectedFiles.length === 0; } renderUploadPreview() { const preview = document.getElementById('uploadPreview'); if (this.selectedFiles.length === 0) { preview.innerHTML = ''; return; } preview.innerHTML = this.selectedFiles.map((file, index) => ` <div class="preview-item"> <img src="${URL.createObjectURL(file)}" alt="${file.name}"> <button class="preview-remove" onclick="adminDashboard.removeFile(${index})">&times;</button> </div> `).join(''); } removeFile(index) { this.selectedFiles.splice(index, 1); this.renderUploadPreview(); document.getElementById('uploadBtn').disabled = this.selectedFiles.length === 0; } async handleUpload() { const category = document.getElementById('imageCategory').value; const tags = document.getElementById('imageTags').value; const description = document.getElementById('imageDescription').value; if (!category) { this.showAlert('Por favor, selecione uma categoria.', 'error'); return; } if (this.selectedFiles.length === 0) { this.showAlert('Por favor, selecione pelo menos uma imagem.', 'error'); return; } this.showAlert('Fazendo upload das imagens...', 'success'); document.getElementById('uploadBtn').disabled = true; try { const formData = new FormData(); this.selectedFiles.forEach(file => { formData.append('images[]', file); }); formData.append('category_id', category); formData.append('tags', tags); formData.append('description', description); const response = await fetch(this.apiBase + 'upload.php', { method: 'POST', body: formData }); const data = await response.json(); if (data.success) { this.showAlert(data.message, 'success'); this.clearUpload(); this.switchSection('gallery'); this.loadImages(); this.loadCategories(); } else { this.showAlert(data.errors ? data.errors.join(', ') : 'Erro no upload', 'error'); } } catch (error) { console.error('Erro no upload:', error); this.showAlert('Erro de conexão durante o upload', 'error'); } finally { document.getElementById('uploadBtn').disabled = false; } } clearUpload() { this.selectedFiles = []; document.getElementById('fileInput').value = ''; document.getElementById('imageCategory').value = ''; document.getElementById('imageTags').value = ''; document.getElementById('imageDescription').value = ''; document.getElementById('uploadPreview').innerHTML = ''; document.getElementById('uploadBtn').disabled = true; } formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; } openImageModal(imageId) { const image = this.images.find(img => img.id === imageId); if (!image) return; document.getElementById('modalImage').src = this.baseUrl + image.filename; document.getElementById('modalImageTitle').textContent = image.name; document.getElementById('editImageName').value = image.name; document.getElementById('editImageCategory').value = image.category; document.getElementById('editImageTags').value = image.tags.join(', '); document.getElementById('editImageDescription').value = image.description; const sizeInfo = document.getElementById('imageSizeInfo'); const dateInfo = document.getElementById('imageDateInfo'); if (sizeInfo) { sizeInfo.textContent = image.size; } if (dateInfo) { dateInfo.textContent = this.formatDate(image.uploadDate); } document.getElementById('imageModal').style.display = 'flex'; document.getElementById('imageModal').dataset.imageId = imageId; document.body.style.overflow = 'hidden'; } formatDate(date) { return new Date(date).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' }); } closeModal() { document.querySelectorAll('.modal').forEach(modal => { modal.style.display = 'none'; }); document.body.style.overflow = ''; } async saveImageChanges() { const imageId = document.getElementById('modalImage').dataset.imageId; const name = document.getElementById('editImageName').value; const category = document.getElementById('editImageCategory').value; const tags = document.getElementById('editImageTags').value; const description = document.getElementById('editImageDescription').value; if (!name || !category) { this.showAlert('Nome e categoria são obrigatórios', 'error'); return; } try { const response = await fetch(this.apiBase + 'images.php', { method: 'PUT', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ id: imageId, name: name, category_id: category, tags: tags, description: description }) }); const data = await response.json(); if (data.success) { this.showAlert('Imagem atualizada com sucesso!', 'success'); this.closeModal(); this.loadImages(); this.loadCategories(); } else { this.showAlert(data.error || 'Erro ao atualizar imagem', 'error'); } } catch (error) { console.error('Erro ao atualizar imagem:', error); this.showAlert('Erro de conexão', 'error'); } } async deleteImage() { if (!confirm('Tem certeza que deseja eliminar esta imagem?')) { return; } const imageId = document.getElementById('modalImage').dataset.imageId; try { const response = await fetch(this.apiBase + 'images.php', { method: 'DELETE', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ id: imageId }) }); const data = await response.json(); if (data.success) { this.showAlert('Imagem eliminada com sucesso!', 'success'); this.closeModal(); this.loadImages(); this.loadCategories(); } else { this.showAlert(data.error || 'Erro ao eliminar imagem', 'error'); } } catch (error) { console.error('Erro ao eliminar imagem:', error); this.showAlert('Erro de conexão', 'error'); } } async addCategory() { const name = document.getElementById('newCategoryName').value.trim(); if (!name) { this.showAlert('Por favor, insira o nome da categoria.', 'error'); return; } try { const response = await fetch(this.apiBase + 'categories.php', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ name: name }) }); const data = await response.json(); if (data.success) { this.showAlert('Categoria adicionada com sucesso!', 'success'); document.getElementById('newCategoryName').value = ''; this.loadCategories(); } else { this.showAlert(data.error || 'Erro ao adicionar categoria', 'error'); } } catch (error) { console.error('Erro ao adicionar categoria:', error); this.showAlert('Erro de conexão', 'error'); } } async editCategory(categoryId) { const category = this.categories.find(cat => cat.id === categoryId); if (!category) return; const newName = prompt('Novo nome da categoria:', category.name); if (!newName || newName === category.name) return; try { const response = await fetch(this.apiBase + 'categories.php', { method: 'PUT', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ id: categoryId, name: newName }) }); const data = await response.json(); if (data.success) { this.showAlert('Categoria atualizada com sucesso!', 'success'); this.loadCategories(); } else { this.showAlert(data.error || 'Erro ao atualizar categoria', 'error'); } } catch (error) { console.error('Erro ao atualizar categoria:', error); this.showAlert('Erro de conexão', 'error'); } } async deleteCategory(categoryId) { const category = this.categories.find(cat => cat.id === categoryId); if (!category) return; if (category.image_count > 0) { this.showAlert('Não é possível eliminar uma categoria que contém imagens.', 'error'); return; } if (!confirm(`Tem certeza que deseja eliminar a categoria "${category.name}"?`)) { return; } try { const response = await fetch(this.apiBase + 'categories.php', { method: 'DELETE', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ id: categoryId }) }); const data = await response.json(); if (data.success) { this.showAlert('Categoria eliminada com sucesso!', 'success'); this.loadCategories(); } else { this.showAlert(data.error || 'Erro ao eliminar categoria', 'error'); } } catch (error) { console.error('Erro ao eliminar categoria:', error); this.showAlert('Erro de conexão', 'error'); } } renderCategories() { const categoriesList = document.getElementById('categoriesList'); if (!categoriesList) return; if (this.categories.length === 0) { categoriesList.innerHTML = '<p>Nenhuma categoria encontrada.</p>'; return; } categoriesList.innerHTML = this.categories.map(category => ` <div class="category-item"> <div class="category-info"> <h4>${category.name}</h4> <span>${category.image_count || 0} imagens</span> </div> <div class="category-actions"> <button class="btn btn-small btn-secondary" onclick="editCategory(${category.id})"> <i class="fas fa-edit"></i> </button> <button class="btn btn-small btn-danger" onclick="deleteCategory(${category.id})"> <i class="fas fa-trash"></i> </button> </div> </div> `).join(''); } updateCategorySelects() { const selects = ['categoryFilter', 'imageCategory', 'editImageCategory']; selects.forEach(selectId => { const select = document.getElementById(selectId); if (!select) return; const currentValue = select.value; const firstOption = select.querySelector('option'); select.innerHTML = ''; if (firstOption) { select.appendChild(firstOption); } this.categories.forEach(category => { const option = document.createElement('option'); option.value = category.id; option.textContent = category.name; select.appendChild(option); }); if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) { select.value = currentValue; } }); } loadSettings() { document.getElementById('maxFileSize').value = this.settings.maxFileSize; document.getElementById('imagesPerPage').value = this.settings.imagesPerPage; document.getElementById('compressionQuality').value = this.settings.compressionQuality; document.getElementById('qualityValue').textContent = this.settings.compressionQuality + '%'; this.settings.allowedFormats.forEach(format => { const checkbox = document.querySelector(`input[value="${format}"]`); if (checkbox) checkbox.checked = true; }); } saveSettings() { this.settings.maxFileSize = parseInt(document.getElementById('maxFileSize').value); this.settings.imagesPerPage = parseInt(document.getElementById('imagesPerPage').value); this.settings.compressionQuality = parseInt(document.getElementById('compressionQuality').value); this.settings.allowedFormats = []; document.querySelectorAll('.checkbox-group input:checked').forEach(checkbox => { this.settings.allowedFormats.push(checkbox.value); }); localStorage.setItem('lisis_admin_settings', JSON.stringify(this.settings)); this.showAlert('Configurações salvas com sucesso!', 'success'); } showAlert(message, type = 'success') { document.querySelectorAll('.alert').forEach(alert => alert.remove()); const alert = document.createElement('div'); alert.className = `alert alert-${type}`; alert.textContent = message; const activeSection = document.querySelector('.content-section.active'); const loginForm = document.querySelector('.login-form'); if (activeSection) { activeSection.insertBefore(alert, activeSection.firstChild); } else if (loginForm) { loginForm.insertBefore(alert, loginForm.firstChild); } else { document.body.appendChild(alert); } setTimeout(() => { if (alert.parentNode) { alert.remove(); } }, 5000); } } document.addEventListener('DOMContentLoaded', () => { window.adminDashboard = new AdminDashboard(); }); function changePage(page) { window.adminDashboard.changePage(page); } function removeFile(index) { window.adminDashboard.removeFile(index); } function editCategory(id) { window.adminDashboard.editCategory(id); } function deleteCategory(id) { window.adminDashboard.deleteCategory(id); }