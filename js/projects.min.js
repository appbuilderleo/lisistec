class ProjectsPage { constructor() { this.apiBase = 'admin/api/'; this.imageBase = 'admin/uploads/images/'; this.projects = []; this.websites = []; this.websitesPage = 1; this.websitesLimit = 12; this.websitesHasMore = false; this.websitesActiveFilter = 'all'; this.websitesTags = new Map(); this.init(); } async init() { await Promise.all([ this.loadWebsites(true), this.loadProjects() ]); const loadMoreBtn = document.getElementById('websitesLoadMoreBtn'); if (loadMoreBtn) { loadMoreBtn.addEventListener('click', () => this.loadWebsites(false)); } } async loadProjects() { const loading = document.getElementById('projectsLoading'); const grid = document.getElementById('projectsGrid'); const noProjects = document.getElementById('noProjects'); try { const response = await fetch(`${this.apiBase}images.php?category=projetos`); const data = await response.json(); loading.style.display = 'none'; if (data.images && data.images.length > 0) { this.projects = data.images; this.renderProjects(); grid.style.display = 'grid'; noProjects.style.display = 'none'; } else { grid.style.display = 'none'; noProjects.style.display = 'block'; } } catch (error) { console.error('Erro ao carregar projetos:', error); loading.style.display = 'none'; grid.style.display = 'none'; noProjects.style.display = 'block'; } } async loadWebsites(reset = false) { const loading = document.getElementById('websitesLoading'); const grid = document.getElementById('websitesGrid'); const noWebsites = document.getElementById('noWebsites'); const filtersEl = document.getElementById('websitesFilters'); const loadMoreContainer = document.getElementById('websitesLoadMoreContainer'); if (!loading || !grid || !noWebsites) return; try { if (reset) { this.websitesPage = 1; this.websites = []; this.websitesTags.clear(); this.websitesActiveFilter = 'all'; if (filtersEl) filtersEl.style.display = 'none'; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; } const params = new URLSearchParams({ category: 'websites', page: String(this.websitesPage), limit: String(this.websitesLimit) }); const response = await fetch(`${this.apiBase}images.php?${params.toString()}`); const data = await response.json(); loading.style.display = 'none'; if (data.images && data.images.length > 0) { this.websites = this.websites.concat(data.images); data.images.forEach(it => { if (Array.isArray(it.tags)) { it.tags.forEach(tag => { const key = String(tag).trim(); if (!key) return; this.websitesTags.set(key, (this.websitesTags.get(key) || 0) + 1); }); } }); this.renderWebsites(); grid.style.display = 'grid'; noWebsites.style.display = 'none'; this.renderWebsitesFilters(); if (filtersEl) filtersEl.style.display = this.websitesTags.size > 0 ? 'flex' : 'none'; this.websitesHasMore = (this.websitesPage < (data.pages || 1)); if (loadMoreContainer) loadMoreContainer.style.display = this.websitesHasMore ? 'block' : 'none'; if (this.websitesHasMore) this.websitesPage += 1; } else { grid.style.display = 'none'; noWebsites.style.display = 'block'; if (filtersEl) filtersEl.style.display = 'none'; if (loadMoreContainer) loadMoreContainer.style.display = 'none'; } } catch (error) { console.error('Erro ao carregar websites:', error); loading.style.display = 'none'; grid.style.display = 'none'; noWebsites.style.display = 'block'; } } renderProjects() { const grid = document.getElementById('projectsGrid'); grid.innerHTML = this.projects.map((project, index) => ` <div class="project-card" data-id="${project.id}" onclick="projectsPage.openProjectModal(${project.id})"> <div class="project-image"> <img src="admin/${project.file_path}" alt="${project.title || project.original_name}" loading="lazy"> ${project.category_name ? `<div class="project-badges"> <div class="project-badge"> <i class="fas fa-tag"></i> ${project.category_name} </div> </div>` : ''} <div class="project-overlay"> <button class="view-project"> <i class="fas fa-eye"></i> Ver Detalhes </button> </div> </div> <div class="project-info"> <h3>${project.title || project.original_name}</h3> <div class="project-meta"> <span class="project-date"> <i class="fas fa-calendar"></i> ${this.formatDate(project.upload_date)} </span> <span class="project-category"> <i class="fas fa-tag"></i> ${project.category_name || 'Projeto'} </span> </div> </div> </div> `).join(''); } renderWebsites() { const grid = document.getElementById('websitesGrid'); if (!grid) return; const items = this.websites.filter(project => { if (this.websitesActiveFilter === 'all') return true; if (!Array.isArray(project.tags)) return false; return project.tags.map(t => String(t).toLowerCase()).includes(this.websitesActiveFilter.toLowerCase()); }); grid.innerHTML = items.map((project) => { const url = this.getWebsiteUrl(project); const overlayAction = url ? `<button type="button" class="view-project" onclick="event.stopPropagation(); projectsPage.openWebsitePreview('${url}')"> <i class="fas fa-external-link-alt"></i> Visualizar o site </button>` : `<button type="button" class="view-project"> <i class="fas fa-eye"></i> Ver Detalhes </button>`; return ` <div class="project-card" data-id="${project.id}" onclick="projectsPage.openProjectModal(${project.id})"> <div class="project-image"> <img src="admin/${project.file_path}" alt="${project.title || project.original_name}" loading="lazy"> ${project.category_name ? `<div class="project-badges"> <div class="project-badge"> <i class="fas fa-globe"></i> Website </div> </div>` : ''} <div class="project-overlay"> ${overlayAction} </div> </div> <div class="project-info"> <h3>${project.title || project.original_name}</h3> <div class="project-meta"> <span class="project-date"> <i class="fas fa-calendar"></i> ${this.formatDate(project.upload_date)} </span> <span class="project-category"> <i class="fas fa-tag"></i> ${project.category_name || 'Website'} </span> </div> </div> </div>`; }).join(''); } renderWebsitesFilters() { const container = document.getElementById('websitesFilters'); if (!container) return; const tags = Array.from(this.websitesTags.entries()) .sort((a, b) => b[1] - a[1]) .map(([tag]) => tag); const topTags = tags.slice(0, 12); container.innerHTML = ` <button class="filter-btn ${this.websitesActiveFilter === 'all' ? 'active' : ''}" data-filter="all">Todos</button> ${topTags.map(t => ` <button class="filter-btn ${this.websitesActiveFilter.toLowerCase() === String(t).toLowerCase() ? 'active' : ''}" data-filter="${String(t)}">${String(t)}</button> `).join('')} `; container.querySelectorAll('.filter-btn').forEach(btn => { btn.addEventListener('click', () => { const value = btn.getAttribute('data-filter') || 'all'; this.websitesActiveFilter = value; container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); this.renderWebsites(); }); }); } openProjectModal(projectId) { const project = this.projects.find(p => p.id == projectId); const item = project || this.websites.find(p => p.id == projectId); if (!item) return; let modal = document.getElementById('projectModal'); if (!modal) { modal = this.createProjectModal(); document.body.appendChild(modal); } modal.querySelector('.modal-image img').src = 'admin/' + item.file_path; modal.querySelector('.modal-image img').alt = item.title || item.original_name; modal.querySelector('.modal-info h2').textContent = item.title || item.original_name; const descriptionEl = modal.querySelector('.modal-description'); if (item.description) { descriptionEl.textContent = item.description; descriptionEl.style.display = 'block'; } else { descriptionEl.style.display = 'none'; } const metaItems = modal.querySelectorAll('.modal-meta .meta-item'); if (metaItems[0]) { metaItems[0].innerHTML = ` <i class="fas fa-calendar"></i> <div> <strong>Data de Upload</strong> <span>${this.formatDate(item.upload_date)}</span> </div> `; } if (metaItems[1]) { metaItems[1].innerHTML = ` <i class="fas fa-tag"></i> <div> <strong>Categoria</strong> <span>${item.category_name || 'Projeto'}</span> </div> `; } if (metaItems[2]) { metaItems[2].innerHTML = ` <i class="fas fa-file"></i> <div> <strong>Nome Original</strong> <span>${item.original_name}</span> </div> `; } if (metaItems[3] && item.tags) { metaItems[3].innerHTML = ` <i class="fas fa-tags"></i> <div> <strong>Tags</strong> <span>${item.tags}</span> </div> `; metaItems[3].style.display = 'flex'; } else if (metaItems[3]) { metaItems[3].style.display = 'none'; } const actions = modal.querySelector('.modal-actions'); const websiteUrl = this.getWebsiteUrl(item); if (websiteUrl) { actions.innerHTML = ` <a href="${websiteUrl}" class="cta-button" target="_blank" rel="noopener"> <i class="fas fa-external-link-alt"></i> Visitar Website </a> <a href="contact.php" class="cta-button"> <i class="fas fa-envelope"></i> Solicitar Orçamento </a>`; } else { actions.innerHTML = ` <a href="contact.php" class="cta-button"> <i class="fas fa-envelope"></i> Solicitar Orçamento </a>`; } modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; } createProjectModal() { const modal = document.createElement('div'); modal.id = 'projectModal'; modal.className = 'project-modal'; modal.innerHTML = ` <div class="modal-content"> <button class="modal-close" onclick="projectsPage.closeProjectModal()"> <i class="fas fa-times"></i> </button> <div class="modal-image"> <img src="" alt=""> </div> <div class="modal-info"> <h2></h2> <p class="modal-description"></p> <div class="modal-meta"> <div class="meta-item"></div> <div class="meta-item"></div> <div class="meta-item"></div> <div class="meta-item"></div> </div> <div class="modal-actions"> <a href="contact.php" class="cta-button"> <i class="fas fa-envelope"></i> Solicitar Orçamento </a> </div> </div> </div> `; return modal; } closeProjectModal() { const modal = document.getElementById('projectModal'); if (modal) { modal.style.display = 'none'; document.body.style.overflow = ''; } } openWebsitePreview(url) { let modal = document.getElementById('websitePreviewModal'); if (!modal) { modal = document.createElement('div'); modal.id = 'websitePreviewModal'; modal.className = 'website-preview-modal'; modal.innerHTML = ` <div class="website-preview-content"> <div class="website-preview-header"> <h3 class="website-preview-title">Pré‑visualização do Website</h3> <div class="website-preview-actions"> <a id="websiteOpenNewTab" href="#" class="cta-button" target="_blank" rel="noopener"> <i class="fas fa-external-link-alt"></i> Abrir em nova aba </a> <button type="button" class="modal-close" aria-label="Fechar" onclick="projectsPage.closeWebsitePreview()"> <i class="fas fa-times"></i> </button> </div> </div> <div class="website-preview-body"> <div id="websitePreviewFallback" class="website-preview-fallback" style="display:none;"> <i class="fas fa-shield-alt"></i> <p>Este website bloqueia a pré‑visualização por motivos de segurança.</p> <a id="websiteFallbackOpen" href="#" class="cta-button" target="_blank" rel="noopener"> <i class="fas fa-external-link-alt"></i> Abrir em nova aba </a> </div> <iframe id="websitePreviewFrame" class="website-preview-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" referrerpolicy="no-referrer"></iframe> </div> </div>`; document.body.appendChild(modal); } const openNewTab = modal.querySelector('#websiteOpenNewTab'); const fallbackOpen = modal.querySelector('#websiteFallbackOpen'); if (openNewTab) openNewTab.href = url; if (fallbackOpen) fallbackOpen.href = url; modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; const iframe = modal.querySelector('#websitePreviewFrame'); const fallback = modal.querySelector('#websitePreviewFallback'); if (!iframe) return; fallback.style.display = 'none'; iframe.style.display = 'block'; iframe.src = 'about:blank'; let loaded = false; const onLoad = () => { loaded = true; }; iframe.removeEventListener('load', onLoad); iframe.addEventListener('load', onLoad, { once: true }); iframe.src = url; setTimeout(() => { if (!loaded) { iframe.style.display = 'none'; fallback.style.display = 'flex'; } }, 4000); } closeWebsitePreview() { const modal = document.getElementById('websitePreviewModal'); if (modal) { const iframe = modal.querySelector('#websitePreviewFrame'); if (iframe) iframe.src = 'about:blank'; modal.style.display = 'none'; document.body.style.overflow = ''; } } getWebsiteUrl(project) { if (!project) return null; if (project.website_url && typeof project.website_url === 'string') { return project.website_url; } const urlRegex = /(https?:\/\/[^\s]+)/i; if (project.description && typeof project.description === 'string') { const match = project.description.match(urlRegex); if (match) return match[1]; } if (Array.isArray(project.tags)) { for (const t of project.tags) { if (typeof t !== 'string') continue; const m = t.match(urlRegex); if (m) return m[1]; if (/^www\./i.test(t)) return 'https: } } return null; } formatDate(dateString) { if (!dateString) return 'Data não disponível'; const date = new Date(dateString); return date.toLocaleDateString('pt-PT', { year: 'numeric', month: 'long', day: 'numeric' }); } } let projectsPage; document.addEventListener('DOMContentLoaded', () => { projectsPage = new ProjectsPage(); }); document.addEventListener('click', (e) => { const modal = document.getElementById('projectModal'); if (modal && e.target === modal) { projectsPage.closeProjectModal(); } }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { projectsPage.closeProjectModal(); } });